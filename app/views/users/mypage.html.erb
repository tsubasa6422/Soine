<div class="container mt-4">
  <div class="row">

    <!-- 左カラム：プロフィール＋子ども一覧 -->
    <div class="col-md-4 mb-4">

      <!-- プロフィールカード -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">

          <div class="text-center mb-3">
            <% if @user.profile_image.attached? %>
              <div class="profile-icon">
                <%= image_tag @user.get_profile_image(100, 100), class: "rounded-circle" %>
              </div>
            <% else %>
              <div class="soine-avatar mx-auto">
                <%= (@user.name.presence || "U").first.upcase %>
              </div>
            <% end %>
          </div>


          <h4 class="d-flex align-items-center justify-content-between">
            <span><%= @user.name.presence || "ユーザー" %></span>
            <%= link_to edit_user_path(@user), class: "text-muted" do %>
               <i class="fa-solid fa-gear"></i>
            <% end %>

          </h4>


          <p class="text-muted mb-1">
            <i class="fas fa-map-marker-alt"></i>
            <%= @user.area&.name || "地域未設定" %>
          </p>

          <p class="mb-0">
            <%= simple_format(@user.introduction.presence || "紹介文はまだ登録されていません。") %>
          </p>
        </div>
      </div>

      <!-- 子ども一覧カード -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">子ども一覧</h5>

          <% if @user.children.any? %>
            <% @user.children.each do |child| %>
              <div class="d-flex align-items-center mb-3">
                <div class="child-avatar me-2">
                  <%= child.name.first.upcase %>
                </div>
                <div>
                  <div><strong><%= child.name %></strong></div>
                  <small class="text-muted">
                    <%= child.respond_to?(:age_label) ? child.age_label : "" %>
                  </small>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">まだ子ども情報が登録されていません。</p>
          <% end %>
        </div>
      </div>

      <div class="card shadow-sm mt-4">
        <div class="card-body">
          <h5 class="mb-3">今の気持ちを投稿する</h5>

          <% if @post.errors.any? %>
            <div class="alert alert-danger py-2">
              <ul class="mb-0">
                <% @post.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>


          <%= form_with model: @post, url: posts_path, local: true do |f| %>
            <div class="mb-2">
              <%= f.label :title, "タイトル", class: "form-label" %>
              <%= f.text_field :title, class: "form-control", placeholder: "例）寝かしつけが大変だった日" %>
            </div>

            <div class="mb-2">
              <%= f.label :body, "本文", class: "form-label" %>
              <%= f.text_area :body,
                    rows: 3,
                    class: "form-control",
                    placeholder: "今日の育児のこと、感じたことを書いてみましょう" %>
            </div>

            <div class="mb-2">
              <%= f.label :images, "画像", class: "form-label" %>
              <%= f.file_field :images, multiple: true, accept: "image/*", class: "form-control" %>
              <small class="text-muted">※ 複数選択できます</small>
            </div>


            <div class="text-end">
              <%= f.submit "投稿する", class: "btn btn-primary btn-sm" %>
            </div>
          <% end %>
        </div>
      </div>

    </div> <!-- /左カラム -->

    <!-- 右カラム：投稿一覧（タイムライン） -->
    <div class="col-md-8">

      <!-- タブ切り替え -->
        <div class="d-flex mb-3">

          <%= link_to "自分の投稿",
                      mypage_path,
                      class: "btn btn-sm me-2 #{params[:filter] == 'timeline' ? 'btn-outline-primary' : 'btn-primary'}" %>


          <%= link_to "タイムライン",
                      mypage_path(filter: 'timeline'),
                      class: "btn btn-sm #{params[:filter] == 'timeline' ? 'btn-primary' : 'btn-outline-primary'}" %>
        </div>

<% if @posts.present? %>
  <% @posts.each do |post| %>
    <div class="card shadow-sm mb-3">
      <div class="card-body">

          <!-- 投稿者情報＋投稿日時 -->
          <div class="d-flex justify-content-between align-items-center small text-muted mb-2">
            <div class="d-flex align-items-center">

              <!-- 投稿者アイコン（クリックでユーザー詳細へ） -->
              <div class="me-2 flex-shrink-0" style="width:32px; height:32px;">
                <%= link_to user_path(post.user), class: "d-inline-block", style: "width:32px; height:32px;" do %>
                  <% if post.user.profile_image.attached? %>
                    <%= image_tag url_for(post.user.profile_image),
                                  class: "rounded-circle",
                                  style: "width:32px; height:32px; object-fit:cover; display:block;" %>
                  <% else %>
                    <div class="soine-avatar-small">
                      <%= (post.user.name.presence || "U").first.upcase %>
                    </div>
                  <% end %>
                <% end %>
              </div>

              <!-- 投稿者名（クリックでユーザー詳細へ） -->
              <strong>
                <%= link_to (post.user.name.presence || "ユーザー"),
                            user_path(post.user),
                            class: "text-decoration-none" %>
              </strong>
            </div>

            <div class="d-flex align-items-center gap-2">
              <span><%= post.created_at.strftime("%Y/%m/%d %H:%M") %></span>

              <% if post.user == current_user %>
                <%= link_to "編集", edit_post_path(post), class: "btn btn-outline-secondary btn-sm" %>
                <%= link_to "削除",
                            post_path(post),
                            method: :delete,
                            data: { confirm: "この投稿を削除しますか？" },
                            class: "btn btn-outline-danger btn-sm" %>
              <% end %>
            </div>
          </div>

          <!-- いいね数・コメント数 -->
          <div class="small d-flex gap-3 align-items-center"
              style="position:absolute; bottom:12px; right:16px;">

            <% if post.liked_by?(current_user) %>
              <%= button_to post_like_path(post),
                            method: :delete,
                            class: "btn p-0 text-warning border-0 bg-transparent",
                            form: { data: { turbo: false } } do %>
                <i class="fa-solid fa-star"></i>
                <%= post.likes.size %>
              <% end %>
            <% else %>
              <%= button_to post_like_path(post),
                            method: :post,
                            class: "btn p-0 text-muted border-0 bg-transparent",
                            form: { data: { turbo: false } } do %>
                <i class="fa-regular fa-star"></i>
                <%= post.likes.size %>
              <% end %>
            <% end %>

            <span class="text-muted">
              <i class="fa-regular fa-comment"></i>
              <%= post.comments.size %>
            </span>
          </div>





        <!-- ここから下だけクリックで詳細へ -->
        <%= link_to post_path(post), class: "text-decoration-none text-dark d-block" do %>

          <% if post.images.attached? %>
            <div class="mb-2 d-flex flex-wrap gap-2">
              <% post.images.each do |image| %>
                <%= image_tag image.variant(resize_to_limit: [240, 240]), class: "rounded" %>
              <% end %>
            </div>
          <% end %>

          <% if post.title.present? %>
            <h6 class="mb-1"><%= post.title %></h6>
          <% end %>

          <p class="mb-0"><%= simple_format(post.body) %></p>

        <% end %>

      </div>
    </div>
  <% end %>
<% else %>
  <p class="text-muted">まだ表示できる投稿がありません。</p>
<% end %>
