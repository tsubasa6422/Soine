<!-- app/views/mypages/show.html.erb -->

<div class="container mt-4">
  <div class="row">

    <!-- 左カラム：プロフィール＋子ども一覧＋投稿フォーム -->
    <div class="col-md-4 mb-4">

      <!-- プロフィールカード -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">

          <div class="text-center mb-3">
            <% if @user.profile_image.attached? %>
              <div class="profile-icon">
                <%= image_tag @user.get_profile_image(100, 100), class: "rounded-circle" %>
              </div>
            <% else %>
              <div class="soine-avatar mx-auto">
                <%= (@user.name.presence || "U").first.upcase %>
              </div>
            <% end %>
          </div>

          <h4 class="d-flex align-items-center justify-content-between">
            <span><%= @user.name.presence || "ユーザー" %></span>
            <!-- 設定アイコン（編集ページへのリンク） -->
            <%= link_to edit_user_path(@user), class: "text-muted" do %>
              <i class="fa-solid fa-gear"></i>
            <% end %>
          </h4>

          <p class="text-muted mb-1">
            <i class="fas fa-map-marker-alt"></i>
            <%= @user.area&.name || "地域未設定" %>
          </p>

          <p class="mb-0">
            <%= simple_format(@user.introduction.presence || "紹介文はまだ登録されていません。") %>
          </p>
        </div>
      </div>

      <!-- 子ども一覧カード -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">子ども一覧</h5>

          <% if @user.children.any? %>
            <% @user.children.each do |child| %>
              <div class="d-flex align-items-center mb-3">
                <div class="child-avatar me-2">
                  <%= child.name.first.upcase %>
                </div>
                <div>
                  <div><strong><%= child.name %></strong></div>
                  <small class="text-muted">
                    <%= child.respond_to?(:age_label) ? child.age_label : "" %>
                  </small>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">まだ子ども情報が登録されていません。</p>
          <% end %>
        </div>
      </div>

      <!-- 今の気持ちを投稿するフォーム -->
      <div class="card shadow-sm mt-4">
        <div class="card-body">
          <h5 class="mb-3">今の気持ちを投稿する</h5>

          <%= form_with model: @post,
                        url: posts_path(filter: params[:filter]),
                        local: true do |f| %>
            <div class="mb-2">
              <%= f.label :title, "タイトル", class: "form-label" %>
              <%= f.text_field :title,
                               class: "form-control",
                               placeholder: "例）寝かしつけが大変だった日" %>
            </div>

            <div class="mb-2">
              <%= f.label :body, "本文", class: "form-label" %>
              <%= f.text_area :body,
                              rows: 3,
                              class: "form-control",
                              placeholder: "今日の育児のこと、感じたことを書いてみましょう" %>
            </div>

            <div class="text-end">
              <%= f.submit "投稿する", class: "btn btn-primary btn-sm" %>
            </div>
          <% end %>
        </div>
      </div>

    </div> <!-- /左カラム -->

    <!-- 右カラム：投稿一覧（自分の投稿 or タイムライン） -->
    <div class="col-md-8">

      <!-- タブ切り替え -->
      <div class="d-flex justify-content-between align-items-center mb-3">

        <div>
          <%= link_to "自分の投稿",
                      mypage_path,
                      class: "btn btn-sm me-2 #{params[:filter].blank? ? 'btn-primary' : 'btn-outline-primary'}" %>

          <%= link_to "タイムライン",
                      mypage_path(filter: 'timeline'),
                      class: "btn btn-sm #{params[:filter] == 'timeline' ? 'btn-primary' : 'btn-outline-primary'}" %>
        </div>

        <!-- 見出し（どちらを表示しているか） -->
        <div class="text-end">
          <% if params[:filter] == 'timeline' %>
            <span class="badge bg-light text-muted">みんなの投稿</span>
          <% else %>
            <span class="badge bg-light text-muted">あなたの投稿</span>
          <% end %>
        </div>

      </div>

      <!-- 投稿一覧 -->
      <% if @posts.present? %>
        <% @posts.each do |post| %>
          <div class="card shadow-sm mb-3">
            <div class="card-body">

              <!-- 投稿者情報＋投稿日時 -->
              <div class="d-flex justify-content-between align-items-center mb-2 small text-muted">
                <div class="d-flex align-items-center">

                  <!-- 投稿者プロフィールアイコン（タイムラインでも自分の投稿でも共通） -->
                  <div class="me-2">
                    <% if post.user.profile_image.attached? %>
                      <%= image_tag post.user.get_profile_image(32, 32),
                                    class: "rounded-circle" %>
                    <% else %>
                      <div class="soine-avatar-small">
                        <%= (post.user.name.presence || "U").first.upcase %>
                      </div>
                    <% end %>
                  </div>

                  <div>
                    <strong><%= post.user.name %></strong>
                    <% if post.user.area.present? %>
                      <small class="text-muted d-block">
                        <i class="fas fa-map-marker-alt"></i>
                        <%= post.user.area.name %>
                      </small>
                    <% end %>
                  </div>
                </div>

                <span><%= post.created_at.strftime("%Y/%m/%d %H:%M") %></span>
              </div>

              <!-- タイトル -->
              <% if post.title.present? %>
                <h6 class="mb-1"><%= post.title %></h6>
              <% end %>

              <!-- 本文 -->
              <p class="mb-0"><%= simple_format(post.body) %></p>

            </div>
          </div>
        <% end %>
      <% else %>
        <% if params[:filter] == 'timeline' %>
          <p class="text-muted">まだタイムラインに表示できる投稿がありません。</p>
        <% else %>
          <p class="text-muted">まだあなたの投稿がありません。「今の気持ちを投稿する」から書いてみましょう。</p>
        <% end %>
      <% end %>

    </div> <!-- /右カラム -->

  </div> <!-- /row -->
</div>
