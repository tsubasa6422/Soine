<div class="container mt-4">
  <div class="card shadow-sm mb-3">
    <div class="card-body">

      <!-- タイトル + 切り替えボタン -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">投稿検索</h4>

        <%= link_to search_users_path, class: "btn btn-outline-secondary btn-sm" do %>
          <i class="fa-solid fa-users"></i> ユーザー検索へ
        <% end %>
      </div>

      <%= form_with url: search_path, method: :get, local: true do |f| %>
        <div class="row g-2 align-items-center">
          <div class="col-md-5">
            <%= f.text_field :q,
                             value: params[:q],
                             class: "form-control",
                             placeholder: "タイトル・本文で検索" %>
          </div>

          <div class="col-md-3">
            <%= f.select :area_id,
                         options_from_collection_for_select(Area.all, :id, :name, params[:area_id]),
                         { include_blank: "地域（すべて）" },
                         class: "form-select" %>
          </div>

          <div class="col-md-3">
            <%= f.select :sort,
                         [
                           ["新しい順", "new"],
                           ["古い順", "old"],
                           ["地域（昇順）", "area_asc"],
                           ["地域（降順）", "area_desc"],
                           ["いいね多い順", "likes_desc"]
                         ],
                         { selected: params[:sort].presence || "new" },
                         class: "form-select" %>
          </div>

          <div class="col-md-1 d-grid">
            <%= f.submit "検索", class: "btn btn-primary" %>
          </div>
        </div>

        <div class="mt-2">
          <%= link_to "クリア", search_path, class: "btn btn-outline-secondary btn-sm" %>
        </div>
      <% end %>

      <% if params[:q].present? %>
        <div class="text-muted small mt-2">
          「<%= params[:q] %>」の検索結果：<%= @posts.size %> 件
        </div>
      <% end %>
    </div>
  </div>

 <% @posts.each do |post| %>
  <div class="card shadow-sm mb-3 position-relative">
    <div class="card-body pb-4">

      <!-- 投稿者情報＋投稿日時 -->
      <div class="d-flex justify-content-between align-items-center small text-muted mb-2">
        <div class="d-flex align-items-center">

          <!-- 投稿者アイコン -->
          <div class="me-2 flex-shrink-0" style="width:32px; height:32px;">
            <%= link_to user_path(post.user), class: "d-inline-block", style: "width:32px; height:32px;" do %>
              <% if post.user.profile_image.attached? %>
                <%= image_tag url_for(post.user.profile_image),
                              class: "rounded-circle",
                              style: "width:32px; height:32px; object-fit:cover; display:block;" %>
              <% else %>
                <div class="soine-avatar-small">
                  <%= (post.user.name.presence || "U").first.upcase %>
                </div>
              <% end %>
            <% end %>
          </div>

          <!-- 投稿者名 -->
          <strong>
            <%= link_to (post.user.name.presence || "ユーザー"),
                        user_path(post.user),
                        class: "text-decoration-none" %>
          </strong>
        </div>

        <!-- 投稿日時 -->
        <span><%= post.created_at.strftime("%Y/%m/%d %H:%M") %></span>
      </div>

      <!-- 右下：いいね数・コメント数 -->
        <div class="small d-flex gap-3 align-items-center"
            style="position:absolute; bottom:12px; right:16px;">

          <!-- いいねボタン -->
          <% if post.liked_by?(current_user) %>
            <%= button_to post_like_path(post),
                          method: :delete,
                          class: "btn p-0 text-warning border-0 bg-transparent",
                          form: { data: { turbo: false } } do %>
              <i class="fa-solid fa-star"></i>
              <%= post.likes.size %>
            <% end %>
          <% else %>
            <%= button_to post_like_path(post),
                          method: :post,
                          class: "btn p-0 text-muted border-0 bg-transparent",
                          form: { data: { turbo: false } } do %>
              <i class="fa-regular fa-star"></i>
              <%= post.likes.size %>
            <% end %>
          <% end %>

          <!-- コメント数 -->
          <span class="text-muted">
            <i class="fa-regular fa-comment"></i>
            <%= post.comments.size %>
          </span>
        </div>


      <!-- ここから下をクリックで投稿詳細へ -->
      <%= link_to post_path(post), class: "text-decoration-none text-dark d-block" do %>

        <!-- 投稿画像 -->
        <% if post.images.attached? %>
          <div class="mb-2 d-flex flex-wrap gap-2">
            <% post.images.each do |image| %>
              <%= image_tag image.variant(resize_to_limit: [240, 240]),
                            class: "rounded" %>
            <% end %>
          </div>
        <% end %>

        <!-- タイトル -->
        <% if post.title.present? %>
          <h6 class="mb-1"><%= post.title %></h6>
        <% end %>

        <!-- 本文 -->
        <p class="mb-0"><%= simple_format(post.body) %></p>

      <% end %>

    </div>
  </div>
<% end %>
